# 插件自动同步和打包工作流

## 概述

这个仓库包含了一个自动同步和打包BetterNCM插件的GitHub Actions工作流。该工作流会定期检查源代码仓库（BetterNCM/BetterNCM-Plugins）的`plugins-data`目录是否有更新，如果有更新则自动打包并发布到当前镜像仓库。

## 工作流功能

### 触发条件

- **定时触发**: 每6小时自动检查一次
- **手动触发**: 可以在GitHub Actions页面手动运行

### 主要步骤

1. **检查更新**: 比较源仓库`plugins-data`目录的最新提交与上次同步的提交
2. **环境准备**: 如果有更新，设置Node.js环境并安装依赖
3. **备份保护**: 备份当前仓库的workflows，防止被覆盖
4. **执行打包**: 运行源仓库的打包脚本
5. **智能同步**: 将新打包的文件复制到当前仓库（保留旧版本插件）
6. **恢复workflows**: 恢复备份的workflows文件
7. **清理临时文件**: 删除临时的source目录
8. **提交推送**: 提交更改并推送到当前仓库

### 关键特性

- **增量检查**: 只有当`plugins-data`有实际更新时才执行打包
- **版本保留**: 保留所有插件的历史版本，只覆盖同名文件
- **Workflow保护**: 自动备份和恢复`.github/workflows`目录，避免被源仓库覆盖
- **状态记录**: 使用`.last-sync-commit`文件记录上次同步的提交hash
- **临时文件清理**: 自动清理构建过程中的临时文件
- **错误处理**: 包含超时设置和错误处理机制

## 文件说明

- `.github/workflows/sync-and-pack.yml`: 主要的工作流文件
- `.last-sync-commit`: 记录上次同步的提交hash（自动生成和更新）
- `up-repositry/`: 源代码仓库的本地克隆

## 使用说明

### 首次运行

工作流会自动检测是否为首次运行，并执行完整的打包流程。

### 监控运行状态

可以在GitHub仓库的"Actions"标签页查看工作流的运行状态和日志。

### 手动触发

如果需要立即检查和同步，可以在Actions页面点击"Run workflow"按钮手动触发。

## 配置说明

### 定时设置

当前设置为每6小时检查一次，可以通过修改`.github/workflows/sync-and-pack.yml`中的cron表达式来调整：

```yaml
schedule:
  - cron: '0 */6 * * *' # 每6小时
```

常用的cron表达式示例：

- `0 */2 * * *`: 每2小时
- `0 8,20 * * *`: 每天8点和20点
- `0 0 * * *`: 每天午夜

### 权限说明

工作流使用默认的`GITHUB_TOKEN`，具有当前仓库的读写权限。

## 故障排除

### 常见问题

1. **工作流执行失败**
   - 检查Actions页面的错误日志
   - 确认源仓库是否可访问
   - 检查依赖安装是否成功

2. **文件同步不完整**
   - 检查源仓库的打包脚本是否正常运行
   - 查看是否有文件权限问题

3. **Workflows被覆盖**
   - 工作流包含了自动备份和恢复机制
   - 如果仍有问题，可以手动恢复workflows文件

### 日志查看

在GitHub Actions页面可以查看详细的执行日志，包括：

- 更新检查结果
- 打包过程输出
- 文件同步状态
- 提交推送结果

## 维护说明

### 定期检查

建议定期检查以下内容：

- 工作流运行状态
- 源仓库的打包脚本是否有变更
- 依赖包是否需要更新

### 更新依赖

如果源仓库的打包脚本依赖发生变化，可能需要更新工作流中的依赖安装部分。

## 注意事项

1. **不要手动编辑打包生成的文件**，因为下次同步时会被覆盖
2. **自定义的workflows文件会被自动保护**，不会被源仓库覆盖
3. **`.last-sync-commit`文件是自动管理的**，请勿手动修改
4. **工作流运行需要一定时间**，特别是首次运行或大量插件更新时

## 贡献

如果发现问题或需要改进，请提交Issue或Pull Request。
