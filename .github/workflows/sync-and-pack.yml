name: 'Sync and Pack Plugins'

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 */6 * * *' # æ¯6å°æ—¶æ£€æŸ¥ä¸€æ¬¡

concurrency:
  group: 'sync-and-pack'
  cancel-in-progress: true

jobs:
  sync-and-pack:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout current repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout source repo
        uses: actions/checkout@v4
        with:
          repository: 'BetterNCM/BetterNCM-Plugins'
          path: 'source'
          fetch-depth: 0

      - name: Check for plugins-data changes
        id: check-changes
        run: |
          cd source
          # è·å–æœ€æ–°çš„ plugins-data ç›®å½•çš„æäº¤hash
          if ! LATEST_COMMIT=$(git log -1 --format="%H" -- plugins-data 2>/dev/null); then
            echo "âŒ æ— æ³•è·å– plugins-data çš„æäº¤å†å²"
            exit 1
          fi
          echo "latest_commit=$LATEST_COMMIT" >> $GITHUB_OUTPUT
          echo "âœ… æœ€æ–°æäº¤: $LATEST_COMMIT"
          
          cd ..
          # æ£€æŸ¥æ˜¯å¦æœ‰è®°å½•ä¸Šæ¬¡åŒæ­¥çš„æäº¤hash
          if [ -f .last-sync-commit ]; then
            LAST_SYNC_COMMIT=$(cat .last-sync-commit)
            echo "last_sync_commit=$LAST_SYNC_COMMIT" >> $GITHUB_OUTPUT
            echo "ğŸ“‹ ä¸Šæ¬¡åŒæ­¥: $LAST_SYNC_COMMIT"
            
            # æ¯”è¾ƒæ˜¯å¦æœ‰å˜åŒ–
            if [ "$LATEST_COMMIT" != "$LAST_SYNC_COMMIT" ]; then
              echo "has_changes=true" >> $GITHUB_OUTPUT
              echo "ğŸ”„ æ£€æµ‹åˆ° plugins-data æœ‰æ›´æ–°: $LAST_SYNC_COMMIT -> $LATEST_COMMIT"
            else
              echo "has_changes=false" >> $GITHUB_OUTPUT
              echo "âœ… plugins-data æ— æ›´æ–°ï¼Œè·³è¿‡æ‰“åŒ…"
            fi
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ†• é¦–æ¬¡è¿è¡Œï¼Œå°†è¿›è¡Œå®Œæ•´æ‰“åŒ…"
          fi

      - name: Set up Node.js
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          cd source
          if [ -f package.json ]; then
            echo "ğŸ“¦ å®‰è£…æ ¹ç›®å½•ä¾èµ–..."
            npm ci || npm install
          else
            echo "âš ï¸ æœªæ‰¾åˆ°æ ¹ç›®å½• package.jsonï¼Œè·³è¿‡"
          fi

      - name: Install script dependencies
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          cd source/scripts
          # æ£€æŸ¥æ˜¯å¦å­˜åœ¨package.json
          if [ ! -f package.json ]; then
            echo "ğŸ“ åˆ›å»º scripts/package.json..."
            cat > package.json << 'EOF'
          {
            "name": "pack-plugins-scripts",
            "version": "1.0.0",
            "type": "module",
            "dependencies": {
              "compressing": "^1.6.2",
              "fs-extra": "^11.1.0",
              "compare-versions": "^5.0.1"
            }
          }
          EOF
          fi
          
          echo "ğŸ“¦ å®‰è£…è„šæœ¬ä¾èµ–..."
          npm install

      - name: Backup current workflows
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          echo "ğŸ’¾ å¤‡ä»½å½“å‰ workflows..."
          mkdir -p /tmp/backup-workflows
          if [ -d ".github/workflows" ]; then
            cp -r .github/workflows/* /tmp/backup-workflows/ 2>/dev/null || true
            echo "âœ… Workflows å·²å¤‡ä»½"
          fi

      - name: Run pack script
        if: steps.check-changes.outputs.has_changes == 'true'
        timeout-minutes: 20
        run: |
          cd source/scripts/pack-plugins
          echo "ğŸ”¨ å¼€å§‹æ‰§è¡Œæ‰“åŒ…è„šæœ¬..."
          
          # æ£€æŸ¥æ‰“åŒ…è„šæœ¬æ˜¯å¦å­˜åœ¨
          if [ ! -f pack-plugins.js ]; then
            echo "âŒ æ‰“åŒ…è„šæœ¬ä¸å­˜åœ¨"
            exit 1
          fi
          
          # æ‰§è¡Œæ‰“åŒ…
          node pack-plugins.js
          echo "âœ… æ‰“åŒ…å®Œæˆ"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify packed files
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          cd source
          echo "ğŸ” éªŒè¯æ‰“åŒ…ç»“æœ..."
          
          if [ ! -d tmp ]; then
            echo "âŒ æ‰“åŒ…è¾“å‡ºç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          if [ ! -f tmp/plugins.json ]; then
            echo "âŒ plugins.json ä¸å­˜åœ¨"
            exit 1
          fi
          
          PLUGIN_COUNT=$(find tmp/plugins -name "*.plugin" 2>/dev/null | wc -l || echo "0")
          echo "ğŸ“¦ æ‰“åŒ…çš„æ’ä»¶æ•°é‡: $PLUGIN_COUNT"
          
          if [ "$PLUGIN_COUNT" -eq 0 ]; then
            echo "âš ï¸ è­¦å‘Š: æ²¡æœ‰æ‰¾åˆ°æ‰“åŒ…çš„æ’ä»¶æ–‡ä»¶"
          fi

      - name: Copy packed files to current repo
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          echo "ğŸ“ æ›´æ–°å½“å‰ä»“åº“çš„æ’ä»¶æ–‡ä»¶..."
          
          # å¤åˆ¶æ–°çš„æ‰“åŒ…æ–‡ä»¶ï¼ˆä¿ç•™æ—§ç‰ˆæœ¬ï¼Œåªè¦†ç›–åŒåæ–‡ä»¶ï¼‰
          if [ -d "source/tmp" ]; then
            # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
            mkdir -p plugins previews
            
            # å¤åˆ¶æ’ä»¶æ–‡ä»¶
            if [ -d "source/tmp/plugins" ]; then
              cp -rf source/tmp/plugins/* plugins/ 2>/dev/null || true
            fi
            
            # å¤åˆ¶é¢„è§ˆå›¾
            if [ -d "source/tmp/previews" ]; then
              cp -rf source/tmp/previews/* previews/ 2>/dev/null || true
            fi
            
            # å¤åˆ¶plugins.json
            if [ -f "source/tmp/plugins.json" ]; then
              cp source/tmp/plugins.json .
            fi
            
            echo "âœ… æ–‡ä»¶åŒæ­¥å®Œæˆï¼ˆä¿ç•™æ—§ç‰ˆæœ¬æ’ä»¶ï¼‰"
          else
            echo "âŒ æºæ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          # æ¢å¤workflows
          if [ -d "/tmp/backup-workflows" ] && [ "$(ls -A /tmp/backup-workflows 2>/dev/null)" ]; then
            mkdir -p .github/workflows
            cp -r /tmp/backup-workflows/* .github/workflows/
            echo "âœ… Workflows å·²æ¢å¤"
          fi

      - name: Get commit info for later use
        if: steps.check-changes.outputs.has_changes == 'true'
        id: commit-info
        run: |
          cd source
          COMMIT_MSG=$(git log -1 --format="%s" -- plugins-data 2>/dev/null || echo "æ’ä»¶æ›´æ–°")
          COMMIT_HASH=$(git log -1 --format="%h" -- plugins-data 2>/dev/null || echo "unknown")
          echo "commit_msg=$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
          cd ..

      - name: Update sync commit record
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          echo "${{ steps.check-changes.outputs.latest_commit }}" > .last-sync-commit
          echo "ğŸ“ åŒæ­¥è®°å½•å·²æ›´æ–°"

      - name: Clean up temporary files
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          # æ¸…ç†ä¸´æ—¶ç›®å½•ï¼Œé¿å…æäº¤åˆ°ä»“åº“
          if [ -d "source" ]; then
            rm -rf source
            echo "ğŸ§¹ ä¸´æ—¶sourceç›®å½•å·²æ¸…ç†"
          fi

      - name: Commit and push changes
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]â€œ
          git add .
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
          if git diff --staged --quiet; then
            echo "â„¹ï¸ æ²¡æœ‰æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤"
          else
            # ä½¿ç”¨é¢„å…ˆè·å–çš„æäº¤ä¿¡æ¯
            COMMIT_MSG="${{ steps.commit-info.outputs.commit_msg }}"
            COMMIT_HASH="${{ steps.commit-info.outputs.commit_hash }}"
            
            git commit -m "ğŸ¤– è‡ªåŠ¨åŒæ­¥æ’ä»¶æ›´æ–° ${COMMIT_HASH}"
            git push
            echo "âœ… æ’ä»¶æ›´æ–°å·²åŒæ­¥å¹¶æäº¤åˆ°å½“å‰ä»“åº“"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "ğŸ“Š åŒæ­¥æ€»ç»“"
          echo "===================="
          if [ "${{ steps.check-changes.outputs.has_changes }}" == "true" ]; then
            echo "âœ… æ£€æµ‹åˆ°æ›´æ–°å¹¶å·²å®ŒæˆåŒæ­¥"
            echo "ğŸ“‹ æœ€æ–°æäº¤: ${{ steps.check-changes.outputs.latest_commit }}"
            
            # ç»Ÿè®¡ä¿¡æ¯
            if [ -f "plugins.json" ]; then
              PLUGIN_COUNT=$(grep -o '"name":' plugins.json | wc -l || echo "unknown")
              echo "ğŸ“¦ å½“å‰æ’ä»¶æ€»æ•°: $PLUGIN_COUNT"
            fi
          else
            echo "â„¹ï¸ æ— æ›´æ–°ï¼Œè·³è¿‡åŒæ­¥"
            echo "ğŸ“‹ å½“å‰åŒæ­¥ç‰ˆæœ¬: ${{ steps.check-changes.outputs.latest_commit }}"
          fi
          echo "===================="
